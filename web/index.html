<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AITuber OnAir Puppet Controller</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 24px; background: #f5f5f5; }
      main { max-width: 640px; margin: 0 auto; background: white; padding: 24px; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,0.08); }
      .header-row { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 16px; }
      h1 { margin: 0; font-size: 1.6rem; }
      .logo { height: 96px; width: auto; }
      textarea { width: 100%; min-height: 120px; font-size: 1rem; padding: 12px; border-radius: 8px; border: 1px solid #d0d0d0; resize: vertical; box-sizing: border-box; }
      button { margin-top: 16px; padding: 12px 24px; font-size: 1rem; border: none; border-radius: 999px; background: #5865f2; color: white; cursor: pointer; }
      button:hover { background: #4752c4; }
      .log { margin-top: 20px; display: flex; flex-direction: column; gap: 12px; max-height: 260px; overflow-y: auto; padding: 4px; }
      .log-entry { padding: 14px 16px; border-radius: 12px; border: 1px solid #dbe1ff; background: #ffffff; box-shadow: 0 4px 12px rgba(71, 82, 196, 0.1); display: flex; gap: 16px; justify-content: space-between; align-items: flex-start; }
      .log-body { margin: 0; font-size: 0.95rem; line-height: 1.5; white-space: pre-wrap; word-break: break-word; flex: 1; }
      .log-timestamp { margin: 0; font-size: 0.8rem; color: #666; white-space: nowrap; }
      .status-main { margin-bottom: 4px; font-size: 1rem; color: #444; transition: color 0.2s ease; }
      .status-main[data-state="connected"] { color: #2b8a3e; }
      .status-main[data-state="disconnected"],
      .status-main[data-state="error"] { color: #c92a2a; }
      .status-note { margin-bottom: 12px; font-size: 0.8rem; color: #666; }
      .status-updated { margin-bottom: 12px; font-size: 0.75rem; color: #777; }
      form { margin-top: 16px; }
      label { display: block; margin-bottom: 8px; font-weight: 600; }
    </style>
  </head>
  <body>
    <main>
      <div class="header-row">
        <h1>AITuber OnAir Puppet Controller</h1>
        <img class="logo" src="logo/aituber-onair-puppet-controller_logo.png" alt="AITuber OnAir Puppet Controller logo" />
      </div>
      <p>AITuber OnAir を <code>ws://localhost:9000/direct-speech</code> に接続してください。</p>
      <div class="status-main" id="clientStatus" data-state="checking">WebSocket clients: checking...</div>
      <p class="status-note" id="clientStatusNote">AITuber OnAir クライアントの接続状況を表示します。</p>
      <p class="status-updated" id="clientStatusUpdated">最終更新: -</p>
      <form id="speechForm">
        <label for="speechText">送信テキスト（「[happy] こんにちは！」 のように感情タグも記述可能です）</label>
        <textarea id="speechText" placeholder="[happy] こんにちは！"></textarea>
        <button type="submit">送信</button>
      </form>
      <div class="log" id="log" role="log" aria-live="polite"></div>
    </main>
    <script>
      const clientStatusEl = document.getElementById('clientStatus');
      const clientStatusNoteEl = document.getElementById('clientStatusNote');
      const clientStatusUpdatedEl = document.getElementById('clientStatusUpdated');
      const logEl = document.getElementById('log');

      const refreshClientStatus = async () => {
        if (clientStatusEl.dataset.state === 'checking') {
          clientStatusEl.textContent = 'WebSocket clients: checking...';
          clientStatusNoteEl.textContent = 'ステータスを取得しています...';
        }
        try {
          const res = await fetch('/status', { cache: 'no-store' });
          if (!res.ok) {
            throw new Error('HTTP ' + res.status);
          }
          const body = await res.json();
          const clients = Math.max(0, body.externalConnections ?? 0);
          if (clients > 0) {
            clientStatusEl.dataset.state = 'connected';
            clientStatusEl.textContent = `WebSocket clients: ${clients}`;
            clientStatusNoteEl.textContent = 'AITuber OnAir クライアントが接続中です。';
          } else {
            clientStatusEl.dataset.state = 'disconnected';
            clientStatusEl.textContent = 'WebSocket clients: 0';
            clientStatusNoteEl.textContent = 'AITuber OnAir クライアントが接続していません。';
          }
          clientStatusUpdatedEl.textContent = '最終更新: ' + new Date().toLocaleTimeString();
        } catch (err) {
          console.error('[status] fetch error', err);
          clientStatusEl.dataset.state = 'error';
          clientStatusEl.textContent = 'WebSocket status: error';
          clientStatusNoteEl.textContent = 'ステータス取得に失敗しました。ページを再読み込みしてください。';
          clientStatusUpdatedEl.textContent = '最終更新: 取得失敗';
          setTimeout(() => {
            clientStatusEl.dataset.state = 'checking';
          }, 3000);
        }
      };

      const addSentCard = (text) => {
        const entry = document.createElement('div');
        entry.className = 'log-entry';

        const bodyEl = document.createElement('p');
        bodyEl.className = 'log-body';
        bodyEl.textContent = text;

        const timeEl = document.createElement('p');
        timeEl.className = 'log-timestamp';
        timeEl.textContent = new Date().toLocaleString();

        entry.append(bodyEl, timeEl);
        logEl.prepend(entry);

        while (logEl.childElementCount > 50) {
          logEl.removeChild(logEl.lastElementChild);
        }
      };
      const ws = new WebSocket('ws://' + location.host + '/direct-speech?client=ui');

      ws.addEventListener('open', () => {
        refreshClientStatus();
      });

      ws.addEventListener('close', () => {
        refreshClientStatus();
      });

      ws.addEventListener('error', (event) => {
        console.error('[ws] error event', event);
        refreshClientStatus();
      });

      refreshClientStatus();
      const statusTimer = setInterval(refreshClientStatus, 3000);
      window.addEventListener('beforeunload', () => {
        clearInterval(statusTimer);
      });

      document.getElementById('speechForm').addEventListener('submit', async (event) => {
        event.preventDefault();
        const textarea = document.getElementById('speechText');
        const text = textarea.value.trim();
        if (!text) {
          alert('テキストを入力してください');
          return;
        }

        try {
          const res = await fetch('/trigger', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({ text }),
          });
          const body = await res.json();
          if (!res.ok || body.error) {
            const message = body.error || ('HTTP ' + res.status);
            alert(message);
            return;
          }
          addSentCard(text);
          textarea.value = '';
          refreshClientStatus();
        } catch (err) {
          console.error('[trigger] fetch error', err);
          alert('送信に失敗しました: ' + err);
        }
      });
    </script>
  </body>
</html>
