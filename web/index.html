<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AITuber OnAir Puppet Controller</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 24px; background: #f5f5f5; }
      main { max-width: 640px; margin: 0 auto; background: white; padding: 24px; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,0.08); }
      .header-row { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 16px; }
      h1 { margin: 0; font-size: 1.6rem; }
      .logo { height: 96px; width: auto; }
      textarea { width: 100%; min-height: 120px; font-size: 1rem; padding: 12px; border-radius: 8px; border: 1px solid #d0d0d0; resize: vertical; box-sizing: border-box; }
      button { margin-top: 16px; padding: 12px 24px; font-size: 1rem; border: none; border-radius: 999px; background: #5865f2; color: white; cursor: pointer; }
      button:hover { background: #4752c4; }
      .log { margin-top: 20px; display: flex; flex-direction: column; gap: 12px; max-height: 260px; overflow-y: auto; padding: 4px; }
      .log-entry { padding: 14px 16px; border-radius: 12px; border: 1px solid #dbe1ff; background: #ffffff; box-shadow: 0 4px 12px rgba(71, 82, 196, 0.1); display: flex; gap: 16px; justify-content: space-between; align-items: flex-start; }
      .log-body { margin: 0; font-size: 0.95rem; line-height: 1.5; white-space: pre-wrap; word-break: break-word; flex: 1; }
      .log-timestamp { margin: 0; font-size: 0.8rem; color: #666; white-space: nowrap; }
      .log-meta { display: flex; flex-direction: row; align-items: center; gap: 8px; }
      .copy-button { margin-top: 0; padding: 8px 16px; font-size: 0.85rem; border-radius: 999px; background: #eff2ff; border: 1px solid #c7d0ff; color: #4752c4; cursor: pointer; transition: background 0.2s ease, color 0.2s ease; }
      .copy-button:hover { background: #dbe1ff; color: #2b3aa5; }
      .copy-button:disabled { background: #f6f7ff; color: #7b84cc; cursor: default; }
      .status-main { margin-bottom: 4px; font-size: 1rem; color: #444; transition: color 0.2s ease; }
      .status-main[data-state="connected"] { color: #2b8a3e; }
      .status-main[data-state="disconnected"],
      .status-main[data-state="error"] { color: #c92a2a; }
      .status-note { margin-bottom: 12px; font-size: 0.8rem; color: #666; }
      .status-updated { margin-bottom: 12px; font-size: 0.75rem; color: #777; }
      form { margin-top: 16px; }
      label { display: block; margin-bottom: 8px; font-weight: 600; }
      .speech-section { margin-top: 16px; padding: 12px 16px; border-radius: 12px; border: 1px solid #dbe1ff; background: #f6f7ff; display: flex; flex-direction: column; gap: 8px; }
      .speech-row { display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
      .speech-status { margin: 0; font-size: 0.9rem; color: #4752c4; flex: 1 1 auto; }
      .speech-row button { margin-top: 0; flex: 0 0 auto; }
      .speech-note { margin: 0; font-size: 0.8rem; color: #c92a2a; }
      button.secondary { background: #818cf8; transition: background 0.2s ease, opacity 0.2s ease; }
      button.secondary:hover { background: #6366f1; }
      button.secondary[data-mode="listening"] { background: #22c55e; }
      button.secondary[data-mode="listening"]:hover { background: #16a34a; }
      button.secondary:disabled { background: #c7d2fe; color: rgba(255,255,255,0.8); cursor: not-allowed; opacity: 0.9; }
    </style>
  </head>
  <body>
    <main>
      <div class="header-row">
        <h1>AITuber OnAir Puppet Controller</h1>
        <img class="logo" src="logo/aituber-onair-puppet-controller_logo.png" alt="AITuber OnAir Puppet Controller logo" />
      </div>
      <p>AITuber OnAir を <code>ws://localhost:9000/direct-speech</code> に接続してください。</p>
      <div class="status-main" id="clientStatus" data-state="checking">WebSocket clients: checking...</div>
      <p class="status-note" id="clientStatusNote">AITuber OnAir クライアントの接続状況を表示します。</p>
      <p class="status-updated" id="clientStatusUpdated">最終更新: -</p>
      <form id="speechForm">
        <label for="speechText">送信テキスト（「[happy] こんにちは！」 のように感情タグも記述可能です）</label>
        <textarea id="speechText" placeholder="[happy] こんにちは！"></textarea>
        <div class="speech-section" aria-live="polite">
          <div class="speech-row">
            <p class="speech-status" id="speechStatus">音声入力は停止中です。</p>
            <button type="button" id="speechToggleButton" class="secondary">音声入力開始</button>
          </div>
          <p class="speech-note" id="speechSupportNote" hidden></p>
        </div>
        <button type="submit">送信</button>
      </form>
      <div class="log" id="log" role="log" aria-live="polite"></div>
    </main>
    <script>
      const clientStatusEl = document.getElementById('clientStatus');
      const clientStatusNoteEl = document.getElementById('clientStatusNote');
      const clientStatusUpdatedEl = document.getElementById('clientStatusUpdated');
      const logEl = document.getElementById('log');

      const copyToClipboard = async (text) => {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
          return;
        }
        const helper = document.createElement('textarea');
        helper.value = text;
        helper.setAttribute('readonly', '');
        helper.style.position = 'fixed';
        helper.style.top = '-9999px';
        document.body.appendChild(helper);
        helper.focus();
        helper.select();
        try {
          const success = document.execCommand('copy');
          if (!success) {
            throw new Error('document.execCommand("copy") failed');
          }
        } finally {
          document.body.removeChild(helper);
        }
      };

      const refreshClientStatus = async () => {
        if (clientStatusEl.dataset.state === 'checking') {
          clientStatusEl.textContent = 'WebSocket clients: checking...';
          clientStatusNoteEl.textContent = 'ステータスを取得しています...';
        }
        try {
          const res = await fetch('/status', { cache: 'no-store' });
          if (!res.ok) {
            throw new Error('HTTP ' + res.status);
          }
          const body = await res.json();
          const clients = Math.max(0, body.externalConnections ?? 0);
          if (clients > 0) {
            clientStatusEl.dataset.state = 'connected';
            clientStatusEl.textContent = `WebSocket clients: ${clients}`;
            clientStatusNoteEl.textContent = 'AITuber OnAir クライアントが接続中です。';
          } else {
            clientStatusEl.dataset.state = 'disconnected';
            clientStatusEl.textContent = 'WebSocket clients: 0';
            clientStatusNoteEl.textContent = 'AITuber OnAir クライアントが接続していません。';
          }
          clientStatusUpdatedEl.textContent = '最終更新: ' + new Date().toLocaleTimeString();
        } catch (err) {
          console.error('[status] fetch error', err);
          clientStatusEl.dataset.state = 'error';
          clientStatusEl.textContent = 'WebSocket status: error';
          clientStatusNoteEl.textContent = 'ステータス取得に失敗しました。ページを再読み込みしてください。';
          clientStatusUpdatedEl.textContent = '最終更新: 取得失敗';
          setTimeout(() => {
            clientStatusEl.dataset.state = 'checking';
          }, 3000);
        }
      };

      const addSentCard = (text) => {
        const entry = document.createElement('div');
        entry.className = 'log-entry';

        const bodyEl = document.createElement('p');
        bodyEl.className = 'log-body';
        bodyEl.textContent = text;

        const metaEl = document.createElement('div');
        metaEl.className = 'log-meta';

        const timeEl = document.createElement('p');
        timeEl.className = 'log-timestamp';
        timeEl.textContent = new Date().toLocaleString();

        const copyButton = document.createElement('button');
        copyButton.type = 'button';
        copyButton.className = 'copy-button';
        copyButton.textContent = 'コピー';
        copyButton.setAttribute('aria-label', 'テキストをコピー');
        copyButton.addEventListener('click', async () => {
          copyButton.disabled = true;
          try {
            await copyToClipboard(text);
            const originalText = copyButton.textContent;
            copyButton.textContent = 'コピーしました';
            setTimeout(() => {
              copyButton.textContent = originalText;
              copyButton.disabled = false;
            }, 2000);
          } catch (err) {
            console.error('[copy] clipboard error', err);
            alert('クリップボードへのコピーに失敗しました');
            copyButton.disabled = false;
          }
        });

        metaEl.append(copyButton, timeEl);
        entry.append(bodyEl, metaEl);
        logEl.prepend(entry);

        while (logEl.childElementCount > 50) {
          logEl.removeChild(logEl.lastElementChild);
          }
      };
      const ws = new WebSocket('ws://' + location.host + '/direct-speech?client=ui');

      ws.addEventListener('open', () => {
        refreshClientStatus();
      });

      ws.addEventListener('close', () => {
        refreshClientStatus();
      });

      ws.addEventListener('error', (event) => {
        console.error('[ws] error event', event);
        refreshClientStatus();
      });

      refreshClientStatus();
      const statusTimer = setInterval(refreshClientStatus, 3000);
      window.addEventListener('beforeunload', () => {
        clearInterval(statusTimer);
      });

      const speechTextEl = document.getElementById('speechText');
      const speechToggleButton = document.getElementById('speechToggleButton');
      const speechStatusEl = document.getElementById('speechStatus');
      const speechSupportNoteEl = document.getElementById('speechSupportNote');

      speechToggleButton.dataset.mode = 'idle';
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        speechStatusEl.textContent = '音声入力は利用できません。';
        speechSupportNoteEl.hidden = false;
        speechSupportNoteEl.textContent = 'このブラウザは音声入力に対応していません。Google Chrome など対応ブラウザをご利用いただくか、テキスト入力をご利用ください。';
        speechToggleButton.disabled = true;
        speechToggleButton.textContent = '音声入力は利用できません';
        speechToggleButton.dataset.mode = 'unsupported';
      } else {
        speechSupportNoteEl.hidden = false;
        speechSupportNoteEl.textContent = '音声入力開始を押すとマイクを使用し、再度押すと停止します。';

        const recognition = new SpeechRecognition();
        recognition.lang = 'ja-JP';
        recognition.continuous = true;
        recognition.interimResults = true;

        let isRecognizing = false;
        let stopRequested = false;

        const setStatus = (text, state) => {
          speechStatusEl.textContent = text;
          if (state) {
            speechStatusEl.dataset.state = state;
          } else {
            delete speechStatusEl.dataset.state;
          }
        };

        recognition.addEventListener('result', (event) => {
          let finalTranscript = '';
          for (let i = event.resultIndex; i < event.results.length; i++) {
            const result = event.results[i];
            if (result.isFinal) {
              finalTranscript += result[0].transcript;
            }
          }
          const trimmed = finalTranscript.trim();
          if (trimmed) {
            const currentValue = speechTextEl.value;
            const needsSeparator = currentValue && !currentValue.endsWith('\n') ? '\n' : '';
            speechTextEl.value = currentValue ? currentValue + needsSeparator + trimmed : trimmed;
            speechTextEl.focus();
            speechTextEl.setSelectionRange(speechTextEl.value.length, speechTextEl.value.length);
            setStatus('音声を認識しました。続けて入力できます。', 'received');
          }
        });

        recognition.addEventListener('start', () => {
          isRecognizing = true;
          stopRequested = false;
          speechToggleButton.disabled = false;
          speechToggleButton.textContent = '音声入力停止';
          speechToggleButton.dataset.mode = 'listening';
          setStatus('音声入力中です。マイクに向かって話してください。', 'listening');
        });

        recognition.addEventListener('end', () => {
          isRecognizing = false;
          speechToggleButton.disabled = false;
          speechToggleButton.textContent = '音声入力開始';
          speechToggleButton.dataset.mode = 'idle';
          if (stopRequested) {
            setStatus('音声入力は停止中です。', 'idle');
          } else {
            setStatus('音声入力が自動停止しました。必要に応じて再開してください。', 'auto-ended');
          }
        });

        recognition.addEventListener('error', (event) => {
          console.error('[speech] recognition error', event);
          speechToggleButton.disabled = false;
          speechToggleButton.textContent = '音声入力開始';
          speechToggleButton.dataset.mode = 'idle';
          let message = '音声入力でエラーが発生しました: ' + event.error;
          if (event.error === 'not-allowed') {
            message = 'マイク利用が拒否されました。ブラウザの設定を確認してください。';
          } else if (event.error === 'no-speech') {
            message = '音声が検出されませんでした。再度お試しください。';
          }
          setStatus(message, 'error');
        });

        speechToggleButton.addEventListener('click', () => {
          if (isRecognizing) {
            stopRequested = true;
            speechToggleButton.disabled = true;
            speechToggleButton.dataset.mode = 'stopping';
            recognition.stop();
            return;
          }
          try {
            speechToggleButton.disabled = true;
            speechToggleButton.dataset.mode = 'starting';
            recognition.start();
          } catch (err) {
            speechToggleButton.disabled = false;
            speechToggleButton.dataset.mode = 'idle';
            console.error('[speech] start error', err);
            setStatus('音声入力の開始に失敗しました。ページを再読み込みして再度お試しください。', 'error');
          }
        });

        window.addEventListener('beforeunload', () => {
          if (isRecognizing) {
            recognition.stop();
          }
        });
      }

      document.getElementById('speechForm').addEventListener('submit', async (event) => {
        event.preventDefault();
        const text = speechTextEl.value.trim();
        if (!text) {
          alert('テキストを入力してください');
          return;
        }

        try {
          const res = await fetch('/trigger', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({ text }),
          });
          const body = await res.json();
          if (!res.ok || body.error) {
            const message = body.error || ('HTTP ' + res.status);
            alert(message);
            return;
          }
          addSentCard(text);
          speechTextEl.value = '';
          refreshClientStatus();
        } catch (err) {
          console.error('[trigger] fetch error', err);
          alert('送信に失敗しました: ' + err);
        }
      });
    </script>
  </body>
</html>
